from telegram import Update
from telegram.ext import Application, CommandHandler, ContextTypes
from flask import Flask, jsonify
import random
import os
from datetime import datetime
import threading
import time

# === ุฅุนุฏุงุฏุงุช ุงูุจูุช ===
TOKEN = "8446070901:AAEEl7gFxqyA_cExC5yGXzygAcZMdjIipmI"
CHANNEL_USERNAME = "@Flix1211"

# === ุชุฎุฒูู ุงูุจูุงูุงุช ===
bot_data = {
    "bot_name": "ุงูุจูุช ุงูุฅุณูุงูู ุงููุชูุฏู",
    "channel": CHANNEL_USERNAME,
    "last_message": "ูู ูุชู ุฅุฑุณุงู ุฑุณุงุฆู ุจุนุฏ",
    "last_time": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
    "total_messages": 0,
    "status": "๐ข ูุนูู - ูุฑุณู ูู 10 ุฏูุงุฆู",
    "start_time": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
    "messages_history": [],
    "message_types": {
        "ุขูุงุช": 0,
        "ุฃุญุงุฏูุซ": 0,
        "ุฃุฐูุงุฑ": 0
    }
}

# === ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฅุณูุงููุฉ ===
islamic_content = {
    "ุขูุงุช": [
        "๐ {ูููู ูููู ุงูููููู ุฃูุญูุฏูุ ุงูููููู ุงูุตููููุฏูุ ูููู ููููุฏู ูููููู ูููููุฏูุ ูููููู ููููู ููููู ููููููุง ุฃูุญูุฏู} - ุณูุฑุฉ ุงูุฅุฎูุงุต",
        "๐ {ุฑูุจููููุง ุขุชูููุง ููู ุงูุฏููููููุง ุญูุณูููุฉู ููููู ุงูุขุฎูุฑูุฉู ุญูุณูููุฉู ููููููุง ุนูุฐูุงุจู ุงููููุงุฑู} - ุณูุฑุฉ ุงูุจูุฑุฉ",
        "๐ {ุฅูููู ููุนู ุงููุนูุณูุฑู ููุณูุฑูุงุ ุฅูููู ููุนู ุงููุนูุณูุฑู ููุณูุฑูุง} - ุณูุฑุฉ ุงูุดุฑุญ",
        "๐ {ููุฅูุฐูุง ุณูุฃููููู ุนูุจูุงุฏูู ุนููููู ููุฅููููู ููุฑููุจู ุฃูุฌููุจู ุฏูุนูููุฉู ุงูุฏููุงุนู ุฅูุฐูุง ุฏูุนูุงูู} - ุณูุฑุฉ ุงูุจูุฑุฉ",
        "๐ {ููุง ุฃููููููุง ุงูููุฐูููู ุขูููููุง ุงุตูุจูุฑููุง ููุตูุงุจูุฑููุง ููุฑูุงุจูุทููุง ููุงุชูููููุง ุงูููููู ููุนูููููููู ุชูููููุญูููู} - ุณูุฑุฉ ุขู ุนูุฑุงู",
        "๐ {ููููู ููุชูููู ุงูููููู ููุฌูุนูู ููููู ููุฎูุฑูุฌูุง ููููุฑูุฒููููู ูููู ุญูููุซู ููุง ููุญูุชูุณูุจู} - ุณูุฑุฉ ุงูุทูุงู",
        "๐ {ุฅูููู ุงูููููู ููุนู ุงูุตููุงุจูุฑูููู} - ุณูุฑุฉ ุงูุจูุฑุฉ",
        "๐ {ููููุง ุชูููุฃูุณููุง ููู ุฑููููุญู ุงูููููู ุฅูููููู ููุง ููููุฃูุณู ููู ุฑููููุญู ุงูููููู ุฅููููุง ุงูููููููู ุงููููุงููุฑูููู} - ุณูุฑุฉ ููุณู",
        "๐ {ููุนูุณูู ุฃูู ุชูููุฑููููุง ุดูููุฆูุง ูููููู ุฎูููุฑู ููููููู ููุนูุณูู ุฃูู ุชูุญูุจูููุง ุดูููุฆูุง ูููููู ุดูุฑูู ููููููู} - ุณูุฑุฉ ุงูุจูุฑุฉ",
        "๐ {ููุฐููููุฑู ููุฅูููู ุงูุฐููููุฑูู ุชููููุนู ุงููููุคูููููููู} - ุณูุฑุฉ ุงูุฐุงุฑูุงุช"
    ],
    
    "ุฃุญุงุฏูุซ": [
        "๐ ูุงู ุฑุณูู ุงููู ๏ทบ: 'ุชุจุณูู ูู ูุฌู ุฃุฎูู ุตุฏูุฉ'",
        "๐ ูุงู ุฑุณูู ุงููู ๏ทบ: 'ุงููููุฉ ุงูุทูุจุฉ ุตุฏูุฉ'",
        "๐ ูุงู ุฑุณูู ุงููู ๏ทบ: 'ุงุชู ุงููู ุญูุซูุง ููุชุ ูุฃุชุจุน ุงูุณูุฆุฉ ุงูุญุณูุฉ ุชูุญูุงุ ูุฎุงูู ุงููุงุณ ุจุฎูู ุญุณู'",
        "๐ ูุงู ุฑุณูู ุงููู ๏ทบ: 'ูู ูุงู ูุคูู ุจุงููู ูุงูููู ุงูุขุฎุฑ ููููู ุฎูุฑุงู ุฃู ููุตูุช'",
        "๐ ูุงู ุฑุณูู ุงููู ๏ทบ: 'ูุง ูุคูู ุฃุญุฏูู ุญุชู ูุญุจ ูุฃุฎูู ูุง ูุญุจ ูููุณู'",
        "๐ ูุงู ุฑุณูู ุงููู ๏ทบ: 'ุฅู ุงููู ูุง ููุธุฑ ุฅูู ุตูุฑูู ูุฃููุงูููุ ูููู ููุธุฑ ุฅูู ูููุจูู ูุฃุนูุงููู'",
        "๐ ูุงู ุฑุณูู ุงููู ๏ทบ: 'ุงูุฑุงุญููู ูุฑุญููู ุงูุฑุญููุ ุงุฑุญููุง ูู ูู ุงูุฃุฑุถ ูุฑุญููู ูู ูู ุงูุณูุงุก'",
        "๐ ูุงู ุฑุณูู ุงููู ๏ทบ: 'ุทูุจ ุงูุนูู ูุฑูุถุฉ ุนูู ูู ูุณูู'",
        "๐ ูุงู ุฑุณูู ุงููู ๏ทบ: 'ุฅููุง ุงูุฃุนูุงู ุจุงูููุงุชุ ูุฅููุง ููู ุงูุฑุฆ ูุง ููู'",
        "๐ ูุงู ุฑุณูู ุงููู ๏ทบ: 'ุงูุฏูู ุงููุตูุญุฉ'"
    ],
    
    "ุฃุฐูุงุฑ": [
        "๐ซ ุณุจุญุงู ุงูููุ ูุงูุญูุฏ ูููุ ููุง ุฅูู ุฅูุง ุงูููุ ูุงููู ุฃูุจุฑ",
        "๐ซ ุฃุณุชุบูุฑ ุงููู ุงูุนุธูู ุงูุฐู ูุง ุฅูู ุฅูุง ูู ุงูุญู ุงููููู ูุฃุชูุจ ุฅููู",
        "๐ซ ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏ ููู ุนูู ูู ุดูุก ูุฏูุฑ",
        "๐ซ ุญุณุจู ุงููู ูุง ุฅูู ุฅูุง ูู ุนููู ุชูููุช ููู ุฑุจ ุงูุนุฑุด ุงูุนุธูู",
        "๐ซ ุจุณู ุงููู ุงูุฐู ูุง ูุถุฑ ูุน ุงุณูู ุดูุก ูู ุงูุฃุฑุถ ููุง ูู ุงูุณูุงุก ููู ุงูุณููุน ุงูุนููู",
        "๐ซ ุฃุนูุฐ ุจูููุงุช ุงููู ุงูุชุงูุงุช ูู ุดุฑ ูุง ุฎูู",
        "๐ซ ุงูููู ุฅูู ุฃุณุฃูู ุนููุงู ูุงูุนุงูุ ูุฑุฒูุงู ุทูุจุงูุ ูุนููุงู ูุชูุจูุงู",
        "๐ซ ุงูููู ุฃูุช ุฑุจู ูุง ุฅูู ุฅูุง ุฃูุชุ ุฎููุชูู ูุฃูุง ุนุจุฏูุ ูุฃูุง ุนูู ุนูุฏู ููุนุฏู ูุง ุงุณุชุทุนุช",
        "๐ซ ุณุจุญุงู ุงููู ูุจุญูุฏูุ ุณุจุญุงู ุงููู ุงูุนุธูู",
        "๐ซ ูุง ุญูู ููุง ููุฉ ุฅูุง ุจุงููู ุงูุนูู ุงูุนุธูู"
    ]
}

# === ุชุทุจูู ููุจ ููุนุฑุถ ===
app = Flask(__name__)

@app.route('/')
def home():
    return """
    <!DOCTYPE html>
    <html dir="rtl">
    <head>
        <meta charset="UTF-8">
        <title>ุงูุจูุช ุงูุฅุณูุงูู ุงููุชูุฏู</title>
        <style>
            body { font-family: Arial; background: #f0f8ff; padding: 40px; text-align: center; }
            .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
            h1 { color: #2c5aa0; }
            .stats { background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 20px 0; }
            .message { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-right: 4px solid #2c5aa0; }
            .types { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
            .type-card { background: #e8f5e8; padding: 15px; border-radius: 10px; }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>๐ ุงูุจูุช ุงูุฅุณูุงูู ุงููุชูุฏู</h1>
            <p>ูุนูู ุนูู ุงูุณุญุงุจุฉ - ูุฑุณู ูู 10 ุฏูุงุฆู โฐ</p>
            
            <div class="stats">
                <h3>๐ ุงูุฅุญุตุงุฆูุงุช</h3>
                <p><strong>ุงูููุงุฉ:</strong> """ + bot_data["channel"] + """</p>
                <p><strong>ุนุฏุฏ ุงูุฑุณุงุฆู:</strong> """ + str(bot_data["total_messages"]) + """</p>
                <p><strong>ุขุฎุฑ ุฑุณุงูุฉ:</strong> """ + bot_data["last_message"] + """</p>
                <p><strong>ุงูููุช:</strong> """ + bot_data["last_time"] + """</p>
                <p><strong>ุงูุญุงูุฉ:</strong> """ + bot_data["status"] + """</p>
            </div>

            <div class="types">
                <div class="type-card">
                    <h4>๐ ุงูุขูุงุช</h4>
                    <p>""" + str(bot_data["message_types"]["ุขูุงุช"]) + """ ุฑุณุงูุฉ</p>
                </div>
                <div class="type-card">
                    <h4>๐ ุงูุฃุญุงุฏูุซ</h4>
                    <p>""" + str(bot_data["message_types"]["ุฃุญุงุฏูุซ"]) + """ ุฑุณุงูุฉ</p>
                </div>
                <div class="type-card">
                    <h4>๐ซ ุงูุฃุฐูุงุฑ</h4>
                    <p>""" + str(bot_data["message_types"]["ุฃุฐูุงุฑ"]) + """ ุฑุณุงูุฉ</p>
                </div>
            </div>
            
            <div class="message">
                <h3>๐จ ุขุฎุฑ ุงูุฑุณุงุฆู</h3>
                <p>""" + bot_data["last_message"] + """</p>
                <small>""" + bot_data["last_time"] + """</small>
            </div>
            
            <p>โฐ ุงูุจูุช ูุฑุณู ุฑุณุงุฆู ุชููุงุฆูุฉ ูู 10 ุฏูุงุฆู ุฅูู ุงูููุงุฉ</p>
            <p>๐ฏ ูุชูุงูุจ ุจูู ุงูุขูุงุช ุงููุฑุขููุฉุ ุงูุฃุญุงุฏูุซ ุงููุจููุฉุ ูุงูุฃุฐูุงุฑ ุงูููููุฉ</p>
        </div>
    </body>
    </html>
    """

@app.route('/api/data')
def api_data():
    return jsonify(bot_data)

@app.route('/api/health')
def health_check():
    return jsonify({"status": "healthy", "timestamp": datetime.now().isoformat()})

def update_bot_data(message, message_type):
    """ุชุญุฏูุซ ุจูุงูุงุช ุงูุจูุช"""
    bot_data["last_message"] = message
    bot_data["last_time"] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    bot_data["total_messages"] += 1
    bot_data["message_types"][message_type] += 1
    
    bot_data["messages_history"].append({
        "message": message,
        "time": bot_data["last_time"],
        "type": message_type
    })
    
    if len(bot_data["messages_history"]) > 20:
        bot_data["messages_history"].pop(0)

# === ุฏูุงู ุจูุช ุงูุชูุฌุฑุงู ===
async def send_islamic_content(context: ContextTypes.DEFAULT_TYPE):
    try:
        # ุชูุงูุจ ุจูู ุฃููุงุน ุงููุญุชูู
        message_types = list(islamic_content.keys())
        current_type = message_types[bot_data["total_messages"] % len(message_types)]
        
        # ุงุฎุชูุงุฑ ุฑุณุงูุฉ ุนุดูุงุฆูุฉ ูู ุงูููุน ุงููุญุฏุฏ
        message = random.choice(islamic_content[current_type])
        
        await context.bot.send_message(
            chat_id=CHANNEL_USERNAME,
            text=message,
            parse_mode='Markdown'
        )
        
        update_bot_data(message, current_type)
        print(f"โ [{datetime.now().strftime('%H:%M:%S')}] ุชู ุฅุฑุณุงู {current_type}: {message[:50]}...")
        
    except Exception as e:
        print(f"โ [{datetime.now().strftime('%H:%M:%S')}] ุฎุทุฃ: {e}")
        bot_data["status"] = f"๐ด ุฎุทุฃ: {str(e)}"

async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        f"๐ ุงูุจูุช ุงูุฅุณูุงูู ุงููุชูุฏู\n\n"
        f"๐ ุงูุฅุญุตุงุฆูุงุช:\n"
        f"โข ุงูููุงุฉ: {CHANNEL_USERNAME}\n"
        f"โข ุงูุฑุณุงุฆู ุงููุฑุณูุฉ: {bot_data['total_messages']}\n"
        f"โข ุขุฎุฑ ุฑุณุงูุฉ: {bot_data['last_time']}\n"
        f"โข ูุนูู ููุฐ: {bot_data['start_time']}\n\n"
        f"๐ฏ ูุฑุณู ูู 10 ุฏูุงุฆู:\n"
        f"โข ๐ ุขูุงุช ูุฑุขููุฉ\n"
        f"โข ๐ ุฃุญุงุฏูุซ ูุจููุฉ\n"
        f"โข ๐ซ ุฃุฐูุงุฑ ููููุฉ\n\n"
        f"โก ูุนูู ุชููุงุฆูุงู 24/7"
    )

def run_flask_app():
    """ุชุดุบูู ุชุทุจูู Flask"""
    port = int(os.environ.get('PORT', 5000))
    print(f"๐ ุจุฏุก ุฎุงุฏู Flask ุนูู ุงููููุฐ {port}")
    app.run(host='0.0.0.0', port=port, debug=False, use_reloader=False)

def run_bot():
    """ุชุดุบูู ุจูุช ุงูุชูุฌุฑุงู"""
    try:
        application = Application.builder().token(TOKEN).build()
        application.add_handler(CommandHandler("start", start_command))
        
        job_queue = application.job_queue
        if job_queue:
            # ุฅุฑุณุงู ุฑุณุงูุฉ ูู 10 ุฏูุงุฆู (600 ุซุงููุฉ)
            job_queue.run_repeating(send_islamic_content, interval=600, first=10)
            print("โ ุชู ุชูุนูู ุงูุฌุฏููุฉ ุงูุชููุงุฆูุฉ - ุฑุณุงุฆู ูู 10 ุฏูุงุฆู")
        
        print("๐ค ุจูุช ุงูุชูุฌุฑุงู ูุนูู...")
        print("โฐ ูุฑุณู ูู 10 ุฏูุงุฆู: ุขูุงุชุ ุฃุญุงุฏูุซุ ุฃุฐูุงุฑ")
        application.run_polling()
        
    except Exception as e:
        print(f"โ ุฎุทุฃ ูู ุชุดุบูู ุงูุจูุช: {e}")
        bot_data["status"] = f"๐ด ุฎุทุฃ: {str(e)}"

if __name__ == "__main__":
    print("๐ ุจุฏุก ุงูุชุดุบูู ุงููุงูู ููุจูุช ุงูุฅุณูุงูู ุงููุชูุฏู...")
    print("๐ฏ ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ:")
    print("   โข โฐ ุฅุฑุณุงู ูู 10 ุฏูุงุฆู")
    print("   โข ๐ ุชูุงูุจ ุจูู ุงูุขูุงุช ูุงูุฃุญุงุฏูุซ ูุงูุฃุฐูุงุฑ")
    print("   โข ๐ ุฅุญุตุงุฆูุงุช ููุตูุฉ")
    
    # ุชุญุฏูุซ ุญุงูุฉ ุงูุจูุช
    bot_data["status"] = "๐ข ูุนูู - ูุฑุณู ูู 10 ุฏูุงุฆู"
    
    # ุชุดุบูู Flask ูู thread ูููุตู
    flask_thread = threading.Thread(target=run_flask_app, daemon=True)
    flask_thread.start()
    
    # ุชุดุบูู ุงูุจูุช ุจุนุฏ ุชุฃุฎูุฑ ุจุณูุท
    time.sleep(5)
    
    # ุชุดุบูู ุงูุจูุช
    run_bot()
